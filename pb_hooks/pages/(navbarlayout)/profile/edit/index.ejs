<script server>
    const user = request.auth
    if (!user) {
        redirect('/login')
    }

    // Fetch fresh user data
    let profile = user
    try {
        profile = $app.findRecordById("users", user.id)
    } catch (e) {
        console.error("Failed to fetch fresh profile:", e)
    }

    if (request.method === 'POST') {
        try {
            const formData = request.formData()

            const name = formData.name
            const bio = formData.bio
            const shortHand = formData.shortHand

            const record = $app.findRecordById("users", user.id)

            if (name) record.set("name", name)
            if (bio) record.set("bio", bio)
            if (shortHand) record.set("shortHand", shortHand)

            // Handle avatar upload
            try {
                let avatar = null // Initialize avatar here

                // Values is undefined because headers is not directly serializable, but request.event exists

                // Trying to access the file via the native request object on the event
                if (request.event && request.event.request) {
                    try {
                        // Check for global findUploadedFiles or $app methods
                        try {
                            console.log("typeof findUploadedFiles:", typeof findUploadedFiles)
                            console.log("typeof $app.findUploadedFiles:", typeof $app.findUploadedFiles)
                            // console.log("typeof filesystem:", typeof filesystem) // might throw if undefined

                            if (typeof findUploadedFiles === 'function') {
                                // request.event.request is the native http.Request
                                const files = findUploadedFiles(request.event.request, "avatar")
                                if (files && files.length > 0) {
                                    avatar = files[0]
                                    console.log("Found avatar via findUploadedFiles")
                                }
                            }
                        } catch (e) {
                            console.log("Error checking helpers:", e)
                        }

                        // If findUploadedFiles didn't work/exist, fall back to inspecting the previous result
                        if (!avatar && request.event && request.event.request) {
                            try {
                                const userFile = request.event.request.formFile("avatar")
                                if (userFile && Array.isArray(userFile)) {
                                    const header = userFile[1]

                                    // Try to create the File object using $filesystem helper (common in PB JS)
                                    try {
                                        console.log("typeof $filesystem:", typeof $filesystem)
                                        if (typeof $filesystem !== 'undefined') {
                                            // Try standard PB JS helper
                                            if ($filesystem.fileFromMultipart) {
                                                avatar = $filesystem.fileFromMultipart(header)
                                                console.log("Created avatar via $filesystem.fileFromMultipart")
                                            } else {
                                                console.log("$filesystem.fileFromMultipart not found")
                                            }
                                        } else {
                                            // Fallback: maybe it is just 'filesystem' but we missed it? No, logs said undefined.
                                            // What about a global 'FileFromMultipart'?
                                            if (typeof FileFromMultipart !== 'undefined') {
                                                avatar = FileFromMultipart(header)
                                                console.log("Created avatar via FileFromMultipart")
                                            }
                                        }
                                    } catch (fsErr) {
                                        console.log("Error using $filesystem:", fsErr)
                                    }

                                    // If still no avatar, we are stuck.
                                    // But wait, if record.set doesn't take header, maybe we can use data structure?
                                    if (!avatar && userFile[1]) {
                                        // Last ditch attempt: some versions might handle the header if wrapped?
                                        // But we saw it fail.
                                    }
                                }
                            } catch (e) {
                                console.log("Error accessing request.event.request.formFile:", e)
                            }
                        }
                    } catch (e) {
                        console.log("Error accessing request.event.request.formFile:", e)
                    }
                }

                // If that failed, let's try reading all form files from the event
                if (!avatar && $app) {
                    // Sometimes we can find it via the reader
                }

                console.log("Avatar final:", avatar)

                // Only update avatar if a valid file with content is uploaded
                // Check if it's a Go MultipartFile (has Size field usually, or just size)
                // In PB JS, formFile returns a filesystem.File
                if (avatar && avatar.size > 0) {
                    record.set("avatar", avatar)
                }
                console.log("--- DEBUG END ---")
            } catch (e) {
                // Ignore avatar errors
                console.log("Avatar processing error:", e)
            }

            $app.save(record)

            // Redirect to profile view after save
            redirect('/profile')
        } catch (err) {
            console.error('Profile update error:', err)
        }
    }
</script>

<div class="container mx-auto px-4 py-8">
    <div class="card bg-base-100 shadow-xl max-w-2xl mx-auto">
        <div class="card-body">
            <h2 class="card-title text-2xl mb-6">Edit Profile</h2>

            <div class="divider"></div>

            <form method="POST" enctype="multipart/form-data" class="space-y-4">
                <div class="form-control w-full">
                    <div class="flex flex-col items-center gap-4">
                        <div class="avatar placeholder cursor-pointer group relative"
                            onclick="document.getElementById('avatar-input').click()">
                            <div
                                class="bg-neutral text-neutral-content rounded-full w-24 group-hover:opacity-80 transition-opacity overflow-hidden ring ring-primary ring-offset-base-100 ring-offset-2">
                                <% if (profile.getString('avatar')) { %>
                                    <img id="avatar-preview"
                                        src="<%= '/api/files/' + profile.collection().id + '/' + profile.id + '/' + profile.getString('avatar') %>"
                                        alt="Avatar" />
                                    <% } else { %>
                                        <div id="avatar-placeholder"
                                            class="text-3xl w-full h-full flex items-center justify-center">
                                            <%= profile.email().slice(0, 1).toUpperCase() %>
                                        </div>
                                        <img id="avatar-preview" class="hidden w-full h-full object-cover" />
                                        <% } %>

                                            <!-- Hover Overlay -->
                                            <div
                                                class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                    stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-white">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" />
                                                </svg>
                                            </div>
                            </div>
                        </div>
                        <span class="text-sm text-base-content/60">Click avatar to change</span>
                    </div>

                    <input id="avatar-input" type="file" name="avatar" class="hidden" accept="image/*"
                        onchange="previewAvatar(this)" />
                </div>

                <script>
                    function previewAvatar(input) {
                        if (input.files && input.files[0]) {
                            const reader = new FileReader();
                            const preview = document.getElementById('avatar-preview');
                            const placeholder = document.getElementById('avatar-placeholder');

                            reader.onload = function (e) {
                                preview.src = e.target.result;
                                preview.classList.remove('hidden');
                                if (placeholder) placeholder.classList.add('hidden');
                            }

                            reader.readAsDataURL(input.files[0]);
                        }
                    }
                </script>

                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Email</span>
                    </label>
                    <input type="text" value="<%= profile.email() %>" class="input input-bordered w-full" disabled />
                </div>

                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Name</span>
                    </label>
                    <input type="text" name="name" value="<%= profile.getString('name') || '' %>"
                        placeholder="Enter your display name" class="input input-bordered w-full" />
                </div>

                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Shorthand</span>
                    </label>
                    <input type="text" name="shortHand" value="<%= profile.getString('shortHand') || '' %>"
                        placeholder="e.g. moviebuff" class="input input-bordered w-full" />
                </div>

                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Bio</span>
                    </label>
                    <textarea name="bio" class="textarea textarea-bordered h-24"
                        placeholder="Tell us about yourself..."><%= profile.getString('bio') || '' %></textarea>
                </div>

                <div class="form-control w-full mt-4">
                    <label class="label">
                        <span class="label-text">Created</span>
                    </label>
                    <input type="text" value="<%= (() => {
                            const d = new Date(profile.getString('created'));
                            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            return `${months[d.getMonth()]} ${d.getDate()} ${d.getFullYear()}`;
                        })() %>" class="input input-bordered w-full" disabled />
                </div>

                <div class="card-actions justify-end mt-6 gap-2">
                    <a href="/profile" class="btn btn-ghost">Cancel</a>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>