<script src="/js/watchlist-detail.js?v=<%= new Date().getTime() %>"></script>
<script id="watchlist-context" type="application/json">
    {
        "movies": <%- JSON.stringify(data.movies || []) %>,
        "isOwner": <%= data.list ? data.list.is_owner : false %>,
        "listId": "<%= data.list ? data.list.id : '' %>",
        "hasMore": <%= data.hasMore !== undefined ? data.hasMore : true %>,
        "currentUserId": "<%= data.user ? data.user.id : '' %>"
    }
</script>
<div class="w-full sm:p-4 pb-0" x-data="(() => {
    try {
        const text = document.getElementById('watchlist-context').textContent;
        const ctx = JSON.parse(text);
        return watchlistDetail(ctx.movies, ctx.isOwner, ctx.listId, ctx.hasMore, ctx.currentUserId);
    } catch(e) {
        console.error('Failed to parse watchlist context', e);
        return watchlistDetail();
    }
})" x-init="
    $dispatch('set-mobile-navbar-title', { 
        title: '<%= data.list ? data.list.title : (data.error ? 'Error' : 'Dank Movies') %>',
        subtitle: '<%= data.list && data.list.description ? data.list.description : '' %>'
    });
">
    <!-- Mobile Header (Removed - Moved to Navbar) -->
    <div class="md:hidden"></div>


    <!-- Desktop Header -->
    <div class="container mx-auto mb-8 hidden md:flex flex-col md:flex-row md:items-center justify-between gap-4">

        <div>
            <div class="flex items-center gap-2 mb-2">
                <a href="/watchlists" class="btn btn-ghost btn-sm gap-2 text-base-content/60 hover:text-primary pl-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Watchlists
                </a>
            </div>
            <% if (data.list) { %>
                <h1
                    class="text-3xl font-bold bg-gradient-to-br from-white to-white/60 bg-clip-text text-transparent drop-shadow-sm">
                    <%= data.list.title %>
                </h1>
                <% if (data.list.description) { %>
                    <p class="text-base-content/80 mt-2 max-w-2xl">
                        <%= data.list.description %>
                    </p>
                    <% } %>
                        <% } else if (data.error) { %>
                            <h1 class="text-2xl font-bold text-error">Error</h1>
                            <p class="text-base-content/60 mt-1">
                                <%= data.error %>
                            </p>
                            <% } %>
                                <% if (data.list) { %>
                                    <p class="text-base-content/60 mt-1">
                                        Created on <%= new Date(data.list.created).toLocaleDateString() %>
                                    </p>
                                    <% } %>
        </div>

        <% if (data.list && data.list.is_owner) { %>
            <div class="flex gap-3">
                <button @click="showEditModal = true"
                    class="btn btn-ghost gap-2 hover:bg-base-100 transition-all duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                    </svg>
                    Edit
                </button>
                <button @click="showShareModal = true"
                    class="btn btn-secondary gap-2 shadow-lg shadow-secondary/20 hover:scale-105 hover:shadow-secondary/40 transition-all duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" />
                    </svg>
                    Share
                </button>
                <a href="/movies/search?watchlistId=<%= data.list.id %>"
                    class="btn btn-primary gap-2 shadow-lg shadow-primary/20 hover:scale-105 hover:shadow-primary/40 transition-all duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                            clip-rule="evenodd" />
                    </svg>
                    Add Movie
                </a>
            </div>
            <% } %>
    </div>

    <!-- Success Message -->
    <% if (data.message) { %>
        <div x-data="{ show: true }" x-show="show" x-transition.duration.300ms
            class="alert alert-success shadow-lg mb-6 flex justify-between">
            <div class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>
                    <%= data.message %>
                </span>
            </div>
            <button @click="show = false" class="btn btn-ghost btn-sm btn-circle">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                        clip-rule="evenodd" />
                </svg>
            </button>
        </div>
        <% } %>

            <!-- Error Message -->
            <% if (data.error && data.list) { %>
                <div class="alert alert-error shadow-lg mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>
                        <%= data.error %>
                    </span>
                </div>
                <% } %>

                    <!-- Modals -->
                    <% if (data.list) { %>
                        <%- include('../../_private/share-modal', { users: data.users, listId: data.list.id }) %>
                            <%- include('../../_private/edit-list-modal', { list: data.list }) %>
                                <%- include('../../_private/delete-list-modal') %>
                                    <%- include('../../_private/edit-entry-modal') %>
                                        <%- include('../../_private/edit-rating-modal') %>
                                            <% } %>

                                                <!-- Delete Entry Modal -->
                                                <%- include('../../_private/delete-entry-modal') %>

                                                    <!-- Content -->
                                                    <% if ((!data.movies || data.movies.length===0) && !data.error) { %>
                                                        <%- include('../../_private/watchlist-empty-state') %>
                                                            <% } else { %>
                                                                <%- include('../../_private/movies-table') %>
                                                                    <% } %>
                                                                        <!-- Mobile Bottom Navigation -->
                                                                        <% if (data.list) { %>
                                                                            <div
                                                                                class="btm-nav md:hidden z-50 bg-base-100/95 backdrop-blur border-t border-base-content/10">
                                                                                <a href="/watchlists"
                                                                                    class="text-base-content/70 hover:text-primary">
                                                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                                                        class="h-5 w-5" fill="none"
                                                                                        viewBox="0 0 24 24"
                                                                                        stroke="currentColor">
                                                                                        <path stroke-linecap="round"
                                                                                            stroke-linejoin="round"
                                                                                            stroke-width="2"
                                                                                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                                                                    </svg>
                                                                                    <span
                                                                                        class="btm-nav-label text-xs">Back</span>
                                                                                </a>

                                                                                <button
                                                                                    @click="$dispatch('toggle-mobile-header')"
                                                                                    class="text-base-content/70 hover:text-primary">
                                                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                                                        class="h-5 w-5" fill="none"
                                                                                        viewBox="0 0 24 24"
                                                                                        stroke="currentColor">
                                                                                        <path stroke-linecap="round"
                                                                                            stroke-linejoin="round"
                                                                                            stroke-width="2"
                                                                                            d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                                                                                    </svg>
                                                                                    <span
                                                                                        class="btm-nav-label text-xs">Fullscreen</span>
                                                                                </button>

                                                                                <% if (data.list.is_owner) { %>
                                                                                    <button
                                                                                        @click="showEditModal = true"
                                                                                        class="text-base-content/70 hover:text-primary">
                                                                                        <svg xmlns="http://www.w3.org/2000/svg"
                                                                                            class="h-5 w-5"
                                                                                            viewBox="0 0 20 20"
                                                                                            fill="currentColor">
                                                                                            <path
                                                                                                d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                                                                        </svg>
                                                                                        <span
                                                                                            class="btm-nav-label text-xs">Edit</span>
                                                                                    </button>

                                                                                    <button
                                                                                        @click="showShareModal = true"
                                                                                        class="text-base-content/70 hover:text-primary">
                                                                                        <svg xmlns="http://www.w3.org/2000/svg"
                                                                                            class="h-5 w-5"
                                                                                            viewBox="0 0 20 20"
                                                                                            fill="currentColor">
                                                                                            <path
                                                                                                d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" />
                                                                                        </svg>
                                                                                        <span
                                                                                            class="btm-nav-label text-xs">Share</span>
                                                                                    </button>

                                                                                    <a href="/movies/search?watchlistId=<%= data.list.id %>"
                                                                                        class="active text-primary bg-primary/10">
                                                                                        <svg xmlns="http://www.w3.org/2000/svg"
                                                                                            class="h-5 w-5"
                                                                                            viewBox="0 0 20 20"
                                                                                            fill="currentColor">
                                                                                            <path fill-rule="evenodd"
                                                                                                d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                                                                                                clip-rule="evenodd" />
                                                                                        </svg>
                                                                                        <span
                                                                                            class="btm-nav-label text-xs">Add</span>
                                                                                    </a>
                                                                                    <% } %>
                                                                            </div>
                                                                            <% } %>
</div>