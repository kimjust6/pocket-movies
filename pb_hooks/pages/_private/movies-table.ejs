<!-- Movies Table -->
<div class="w-full bg-base-100/40 rounded-xl border border-base-content/5 shadow-lg backdrop-blur-sm">
    <table class="table w-full">
        <!-- head -->
        <thead>
            <% const sortableColumns=[ { label: 'Watched On' , key: 'watched_at' }, { label: 'Title' , key: 'title' }, {
                label: 'Release Date' , key: 'release_date' }, { label: 'Runtime' , key: 'runtime' }, { label: 'Score' ,
                key: 'tmdb_score' } ]; %>
                <tr class="bg-base-200 shadow-sm border-b border-base-content/10">
                    <th class="sticky z-30 bg-base-200 backdrop-blur-md" style="top: var(--navbar-height, 80px)">Poster
                    </th>
                    <% sortableColumns.forEach(col=> { %>
                        <th class="sticky z-30 bg-base-200 backdrop-blur-md" style="top: var(--navbar-height, 80px)">
                            <button type="button" @click.prevent="sortBy('<%= col.key %>')"
                                class="flex items-center gap-1 hover:text-primary cursor-pointer select-none bg-transparent border-none p-0 font-inherit">
                                <%= col.label %> <span class="opacity-50 text-xs"
                                        x-text="getSortIcon('<%= col.key %>')"></span>
                            </button>
                        </th>
                        <% }); %>

                            <!-- Member Columns -->
                            <% if (data.members && data.members.length> 0) { %>
                                <% data.members.forEach(member=> { %>
                                    <th class="sticky z-30 bg-base-200 backdrop-blur-md text-center"
                                        style="top: var(--navbar-height, 80px)">
                                        <div class="flex flex-col items-center cursor-pointer hover:opacity-80 transition-opacity"
                                            @click.prevent="sortByUser('<%= member.id %>')"
                                            title="Sort by <%= member.name %>'s rating">
                                            <div class="avatar placeholder">
                                                <div class="bg-neutral text-neutral-content rounded-full w-8 h-8 ring ring-offset-base-100 ring-offset-2"
                                                    :class="sortColumn === 'user_<%= member.id %>' ? 'ring-primary' : 'ring-transparent'">
                                                    <% if (member.avatar) { %>
                                                        <img src="/api/files/users/<%= member.id %>/<%= member.avatar %>"
                                                            alt="<%= member.name %>" />
                                                        <% } else { %>
                                                            <span class="text-xs">
                                                                <%= member.name.charAt(0).toUpperCase() %>
                                                            </span>
                                                            <% } %>
                                                </div>
                                            </div>
                                            <span class="text-[10px] opacity-70 mt-1 max-w-[60px] truncate">
                                                <%= member.name %>
                                                    <span x-show="sortColumn === 'user_<%= member.id %>'"
                                                        x-text="sortDirection === 'asc' ? '↑' : '↓'"
                                                        class="text-[9px]"></span>
                                            </span>
                                        </div>
                                    </th>
                                    <% }) %>
                                        <% } %>

                                            <th class="sticky z-30 bg-base-200 backdrop-blur-md"
                                                style="top: var(--navbar-height, 80px)"></th>
                </tr>
        </thead>
        <tbody>
            <template x-for="movie in movies" :key="movie.history_id">
                <tr class="hover transition-colors duration-200">
                    <td>
                        <div class="avatar">
                            <div class="mask mask-squircle w-12 h-18 bg-base-300">
                                <template x-if="movie.poster_path">
                                    <img :src="'https://image.tmdb.org/t/p/w200' + movie.poster_path" :alt="movie.title"
                                        loading="lazy">
                                </template>
                                <template x-if="!movie.poster_path">
                                    <div class="w-full h-full flex items-center justify-center text-xs opacity-50">
                                        No Img</div>
                                </template>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="flex items-center gap-2">
                            <span x-text="formatDate(movie.watched_at)"></span>
                        </div>
                    </td>
                    <td>
                        <div class="font-bold text-lg">
                            <a :href="'/movies/' + movie.tmdb_id"
                                class="hover:text-primary hover:underline transition-colors" x-text="movie.title"></a>
                        </div>
                        <template x-if="movie.tagline">
                            <div class="text-sm opacity-50 italic max-w-xs truncate" :title="movie.tagline"
                                x-text="movie.tagline">
                            </div>
                        </template>
                    </td>
                    <td x-text="formatDate(movie.release_date)"></td>
                    <td x-text="movie.runtime ? movie.runtime + ' min' : 'N/A'">
                    </td>
                    <td>
                        <div class="flex flex-col gap-1">
                            <span class="badge badge-sm badge-ghost whitespace-nowrap" title="TMDB Score">TMDB:
                                <span x-text="movie.tmdb_score ? movie.tmdb_score : '-'"></span>
                            </span>
                            <span class="badge badge-sm badge-ghost whitespace-nowrap" title="IMDB Score">IMDB:
                                <span x-text="movie.imdb_score ? movie.imdb_score : '-'"></span>
                            </span>
                            <span class="badge badge-sm badge-ghost whitespace-nowrap" title="RT Score">RT:
                                <span x-text="movie.rt_score ? movie.rt_score + '%' : '-'"></span>
                            </span>
                        </div>
                    </td>

                    <!-- Member Data Cells -->
                    <% if (data.members && data.members.length> 0) { %>
                        <% data.members.forEach(member=> { %>
                            <td class="text-center p-0 align-middle">
                                <button type="button" @click.stop="openRatingModal(movie, '<%= member.id %>')"
                                    class="w-full h-full flex flex-col items-center justify-center p-2 min-h-[60px] hover:bg-base-content/5 transition-colors cursor-pointer rounded-lg bg-transparent border-none">
                                    <template x-if="movie.attendance && movie.attendance['<%= member.id %>']">
                                        <div class="flex flex-col items-center gap-1 pointer-events-none">
                                            <template x-if="movie.attendance['<%= member.id %>'].rating">
                                                <div class="badge badge-sm font-bold"
                                                    :class="movie.attendance['<%= member.id %>'].failed ? 'badge-error' : 'badge-success'"
                                                    x-text="formatRating(movie.attendance['<%= member.id %>'].rating) + '/10'">
                                                </div>
                                            </template>

                                            <template x-if="!movie.attendance['<%= member.id %>'].failed">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-success"
                                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M5 13l4 4L19 7" />
                                                </svg>
                                            </template>

                                            <template x-if="movie.attendance['<%= member.id %>'].failed">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                    class="h-6 w-6 text-error opacity-50" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </template>

                                            <!-- Review Indicator -->
                                            <template x-if="movie.attendance['<%= member.id %>'].review">
                                                <div class="tooltip tooltip-bottom z-50 pointer-events-auto"
                                                    :data-tip="movie.attendance['<%= member.id %>'].review">
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                        class="h-4 w-4 text-primary opacity-80" viewBox="0 0 20 20"
                                                        fill="currentColor">
                                                        <path fill-rule="evenodd"
                                                            d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z"
                                                            clip-rule="evenodd" />
                                                    </svg>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                    <template x-if="!movie.attendance || !movie.attendance['<%= member.id %>']">
                                        <span class="opacity-10"
                                            :class="{'opacity-20 text-xs italic': isOwner && '<%= member.id %>' === currentUserId}"
                                            x-text="isOwner && '<%= member.id %>' === currentUserId ? 'Rate' : '-'"></span>
                                    </template>
                                </button>
                            </td>
                            <% }) %>
                                <% } %>

                                    <td>
                                        <template x-if="isOwner">
                                            <button @click="openEditMovieModal(movie)"
                                                class="btn btn-xs btn-ghost btn-circle opacity-50 hover:opacity-100"
                                                title="Edit Entry">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                                </svg>
                                            </button>
                                        </template>
                                    </td>
                </tr>
            </template>
        </tbody>
    </table>

    <!-- Scroll Sentinel for Infinite Scroll -->
    <div id="scroll-sentinel" class="w-full py-4">
        <template x-if="isLoading">
            <div class="flex justify-center items-center py-8">
                <span class="loading loading-spinner loading-lg text-primary"></span>
            </div>
        </template>
        <template x-if="!hasMore && movies.length > 0 && !isLoading">
            <div class="text-center py-4 text-base-content/50">
                <p>You've reached the end of the list</p>
            </div>
        </template>
    </div>
</div>