<div x-show="showAddModal" x-cloak x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm"
    @click.self="showAddModal = false" @keydown.escape.window="showAddModal = false"
    @close-add-modal.window="showAddModal = false">

    <div x-show="showAddModal" x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-95"
        class="relative w-full max-w-md rounded-2xl border border-base-content/10 bg-base-200/95 p-6 shadow-2xl backdrop-blur-xl">

        <div class="mb-4 flex items-center justify-between">
            <h3 class="text-xl font-bold">Add to Watchlist</h3>
            <button @click="showAddModal = false" class="btn btn-circle btn-ghost btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <p class="mb-4 text-base-content/60">Select a watchlist for this movie:</p>

        <div class="flex flex-col gap-3 max-h-[60vh] overflow-y-auto pr-2" x-data="{
                submitting: false,
                message: '',
                error: '',
                tmdbId: '',
                async addToWatchlist(listId) {
                    this.submitting = true;
                    this.message = '';
                    this.error = '';
                    
                    if (!this.tmdbId) {
                        this.error = 'Movie ID is missing';
                        this.submitting = false;
                        return;
                    }
                    
                    try {
                        const formData = new FormData();
                        formData.append('tmdb_id', this.tmdbId);
                        formData.append('watchlist_id', listId);

                        const res = await fetch('/api/watchlists/add', {
                            method: 'POST',
                            body: formData
                        });
                        
                        // Check for JSON response (even on error status it might be JSON)
                        const data = await res.json();

                        if (data.success) {
                            this.message = data.message;
                            if (typeof window.refreshWatchlists === 'function') {
                                window.refreshWatchlists();
                            }
                            // Close modal immediately after success
                            setTimeout(() => {
                                $dispatch('close-add-modal');
                                this.message = '';
                            }, 500); 
                        } else {
                            this.error = data.error;
                        }
                    } catch (e) {
                         this.error = 'Something went wrong: ' + e.message;
                    } finally {
                        this.submitting = false;
                    }
                }
            }" @set-watchlist-movie.window="tmdbId = $event.detail.id; error = ''; message = ''">

            <!-- Messages -->
            <div x-show="message" x-transition class="alert alert-success shadow-sm mb-2 p-2 text-sm text-center">
                <span x-text="message"></span>
            </div>
            <div x-show="error" x-transition class="alert alert-error shadow-sm mb-2 p-2 text-sm text-center">
                <span x-text="error"></span>
            </div>

            <!-- Default List -->
            <button type="button" @click="addToWatchlist('')" :disabled="submitting"
                class="btn btn-outline w-full justify-between hover:bg-primary hover:text-primary-content group transition-all">
                <span class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 text-primary group-hover:text-primary-content" viewBox="0 0 20 20"
                        fill="currentColor">
                        <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" />
                    </svg>
                    Default Watchlist
                </span>
                <span x-show="submitting" class="loading loading-spinner loading-xs text-primary"></span>
                <svg x-show="!submitting" xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
            </button>

            <!-- Custom Lists -->
            <% if (data.lists && data.lists.length> 0) { %>
                <div class="divider text-xs opacity-50 my-2">Custom Lists</div>
                <% data.lists.forEach(list=> { %>
                    <button type="button" @click="addToWatchlist('<%= list.id %>')" :disabled="submitting"
                        class="btn btn-outline w-full justify-between hover:bg-secondary hover:text-secondary-content group transition-all mb-2">
                        <span class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5 text-secondary group-hover:text-secondary-content" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                            </svg>
                            <%= list.list_title %>
                        </span>
                        <span x-show="submitting" class="loading loading-spinner loading-xs text-secondary"></span>
                        <svg x-show="!submitting" xmlns="http://www.w3.org/2000/svg"
                            class="h-4 w-4 opacity-0 group-hover:opacity-100 transition-opacity" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                    </button>
                    <% }) %>
                        <% } %>
        </div>

    </div>
</div>